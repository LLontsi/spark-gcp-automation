---
# Configure Spark Worker nodes

- name: Create Spark Worker systemd service
  ansible.builtin.template:
    src: spark-worker.service.j2
    dest: /etc/systemd/system/spark-worker.service
    mode: '0644'
  become: true
  notify: Restart Spark Worker

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true
  become: true

- name: Enable Spark Worker service
  ansible.builtin.systemd:
    name: spark-worker
    enabled: true
  become: true

- name: Start Spark Worker service
  ansible.builtin.systemd:
    name: spark-worker
    state: started
  become: true

- name: Wait for Worker Web UI to be ready
  ansible.builtin.wait_for:
    port: 8081
    delay: 5
    timeout: 60
  become: true

- name: Wait for worker to register with master
  ansible.builtin.pause:
    seconds: 15

- name: Verify worker connection to master
  ansible.builtin.uri:
    url: "http://{{ spark_master_ip }}:{{ spark_master_webui_port }}"
    return_content: true
  register: master_ui_content
  retries: 5
  delay: 10
  until: >-
    master_ui_content.status == 200 and
    ansible_hostname in master_ui_content.content
  failed_when: false